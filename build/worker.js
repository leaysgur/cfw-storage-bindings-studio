var b=class extends Error{constructor(a,s){super(a),this.name="DevalueError",this.path=s.join("")}};function h(e){return Object(e)!==e}var W=Object.getOwnPropertyNames(Object.prototype).sort().join("\0");function _(e){let a=Object.getPrototypeOf(e);return a===Object.prototype||a===null||Object.getOwnPropertyNames(a).sort().join("\0")===W}function x(e){return Object.prototype.toString.call(e).slice(8,-1)}function Z(e){switch(e){case'"':return'\\"';case"<":return"\\u003C";case"\\":return"\\\\";case`
`:return"\\n";case"\r":return"\\r";case"	":return"\\t";case"\b":return"\\b";case"\f":return"\\f";case"\u2028":return"\\u2028";case"\u2029":return"\\u2029";default:return e<" "?`\\u${e.charCodeAt(0).toString(16).padStart(4,"0")}`:""}}function w(e){let a="",s=0,n=e.length;for(let t=0;t<n;t+=1){let r=e[t],i=Z(r);i&&(a+=e.slice(s,t)+i,s=t+1)}return`"${s===0?e:a+e.slice(s)}"`}function A(e){return Object.getOwnPropertySymbols(e).filter(a=>Object.getOwnPropertyDescriptor(e,a).enumerable)}function m(e,a){return z(JSON.parse(e),a)}function z(e,a){if(typeof e=="number")return t(e,!0);if(!Array.isArray(e)||e.length===0)throw new Error("Invalid input");let s=e,n=Array(s.length);function t(r,i=!1){if(r===-1)return;if(r===-3)return NaN;if(r===-4)return 1/0;if(r===-5)return-1/0;if(r===-6)return-0;if(i)throw new Error("Invalid input");if(r in n)return n[r];let o=s[r];if(!o||typeof o!="object")n[r]=o;else if(Array.isArray(o))if(typeof o[0]=="string"){let u=o[0],c=a?.[u];if(c)return n[r]=c(t(o[1]));switch(u){case"Date":n[r]=new Date(o[1]);break;case"Set":let d=new Set;n[r]=d;for(let l=1;l<o.length;l+=1)d.add(t(o[l]));break;case"Map":let p=new Map;n[r]=p;for(let l=1;l<o.length;l+=2)p.set(t(o[l]),t(o[l+1]));break;case"RegExp":n[r]=new RegExp(o[1],o[2]);break;case"Object":n[r]=Object(o[1]);break;case"BigInt":n[r]=BigInt(o[1]);break;case"null":let I=Object.create(null);n[r]=I;for(let l=1;l<o.length;l+=2)I[o[l]]=t(o[l+1]);break;default:throw new Error(`Unknown type ${u}`)}}else{let u=new Array(o.length);n[r]=u;for(let c=0;c<o.length;c+=1){let d=o[c];d!==-2&&(u[c]=t(d))}}else{let u={};n[r]=u;for(let c in o){let d=o[c];u[c]=t(d)}}return n[r]}return t(0)}function D(e,a){let s=[],n=new Map,t=[];for(let c in a)t.push({key:c,fn:a[c]});let r=[],i=0;function o(c){if(typeof c=="function")throw new b("Cannot stringify a function",r);if(n.has(c))return n.get(c);if(c===void 0)return-1;if(Number.isNaN(c))return-3;if(c===1/0)return-4;if(c===-1/0)return-5;if(c===0&&1/c<0)return-6;let d=i++;n.set(c,d);for(let{key:I,fn:l}of t){let R=l(c);if(R)return s[d]=`["${I}",${o(R)}]`,d}let p="";if(h(c))p=U(c);else switch(x(c)){case"Number":case"String":case"Boolean":p=`["Object",${U(c)}]`;break;case"BigInt":p=`["BigInt",${c}]`;break;case"Date":p=`["Date","${!isNaN(c.getDate())?c.toISOString():""}"]`;break;case"RegExp":let{source:R,flags:T}=c;p=T?`["RegExp",${w(R)},"${T}"]`:`["RegExp",${w(R)}]`;break;case"Array":p="[";for(let f=0;f<c.length;f+=1)f>0&&(p+=","),f in c?(r.push(`[${f}]`),p+=o(c[f]),r.pop()):p+=-2;p+="]";break;case"Set":p='["Set"';for(let f of c)p+=`,${o(f)}`;p+="]";break;case"Map":p='["Map"';for(let[f,$]of c)r.push(`.get(${h(f)?U(f):"..."})`),p+=`,${o(f)},${o($)}`,r.pop();p+="]";break;default:if(!_(c))throw new b("Cannot stringify arbitrary non-POJOs",r);if(A(c).length>0)throw new b("Cannot stringify POJOs with symbolic keys",r);if(Object.getPrototypeOf(c)===null){p='["null"';for(let f in c)r.push(`.${f}`),p+=`,${w(f)},${o(c[f])}`,r.pop();p+="]"}else{p="{";let f=!1;for(let $ in c)f&&(p+=","),f=!0,r.push(`.${$}`),p+=`${w($)}:${o(c[$])}`,r.pop();p+="}"}}return s[d]=p,d}let u=o(e);return u<0?`${u}`:`[${s.join(",")}]`}function U(e){let a=typeof e;return a==="string"?w(e):e instanceof String?w(e.toString()):e===void 0?(-1).toString():e===0&&1/e<0?(-6).toString():a==="bigint"?`["BigInt","${e}"]`:String(e)}var P=e=>decodeURIComponent(e),j=e=>e.constructor.name==="KvNamespace",X=async(e,a)=>{let{operation:s,parameters:n}=m(a.headers.get("X-BRIDGE-KV-Dispatch")??"{}");if(s==="KVNamespace.list"){let[t]=n,r=await e.list(t);return Response.json(r)}if(s==="KVNamespace.put"){let[t,r]=n,i=P(t),o=a.body??"Only for TS, never happens";return await e.put(i,o,r),new Response}if(s==="KVNamespace.getWithMetadata"){let[t,r]=n,i=P(t),{value:o,metadata:u,cacheStatus:c}=await e.getWithMetadata(i,{...typeof r!="string"?r:{},type:"stream"});return new Response(o,{headers:{"X-BRIDGE-KV-ValueIsNull":`${o===null}`,"X-BRIDGE-KV-Metadata":D(u),"X-BRIDGE-KV-CacheStatus":D(c)}})}if(s==="KVNamespace.delete"){let[t]=n,r=P(t);return await e.delete(r),new Response}throw new Error(`${s}() is not supported.`)};var B=e=>e.constructor.name==="Fetcher"||typeof e.fetch=="function",C=async(e,a)=>{let{operation:s,parameters:n}=JSON.parse(a.headers.get("X-BRIDGE-SERVICE-Dispatch")??"{}");if(s==="Fetcher.fetch"){let[t]=n,r=new Request(t,a);return r.headers.delete("X-BRIDGE-BINDING-MODULE"),r.headers.delete("X-BRIDGE-BINDING-NAME"),r.headers.delete("X-BRIDGE-SERVICE-Dispatch"),e.fetch(r)}throw new Error(`${s}() is not supported.`)};var F=e=>{let a=new Uint8Array(e.length/2);for(let s=0;s<e.length;s+=2)a[s/2]=parseInt(e.substring(s,s+2),16);return a.buffer},y=e=>decodeURIComponent(e);var O=e=>e.constructor.name==="R2Bucket",J=async(e,a)=>{let{operation:s,parameters:n}=m(a.headers.get("X-BRIDGE-R2-Dispatch")??"{}",{Headers:t=>new Headers(t),ArrayBuffer:t=>F(t)});if(s==="R2Bucket.list"){let[t]=n,r=await e.list(t);return Response.json(r)}if(s==="R2Bucket.put"){let[t,,r]=n,i=y(t),o=a.body,u=await e.put(i,o,r);return Response.json(u)}if(s==="R2Bucket.get"){let[t,r]=n,i=y(t),o=await e.get(i,r);return o===null?Response.json(null):"body"in o&&o.constructor.name==="GetResult"?new Response(o.body,{headers:{"X-BRIDGE-R2-R2ObjectJSON":JSON.stringify(o)}}):Response.json(o)}if(s==="R2Bucket.head"){let[t]=n,r=y(t),i=await e.head(r);return i===null?Response.json(null):Response.json(i)}if(s==="R2Bucket.delete"){let[t]=n,r=typeof t=="string"?y(t):t.map(i=>y(i));return await e.delete(r),new Response}if(s==="R2Bucket.createMultipartUpload"){let[t,r]=n,i=y(t),o=await e.createMultipartUpload(i,r);return Response.json(o)}if(s==="R2MultipartUpload.uploadPart"){let[t,r,i]=n,o=y(t),u=a.body??"Only for TS, never happens",d=await e.resumeMultipartUpload(o,r).uploadPart(i,u);return Response.json(d)}if(s==="R2MultipartUpload.abort"){let[t,r]=n,i=y(t);return await e.resumeMultipartUpload(i,r).abort(),new Response}if(s==="R2MultipartUpload.complete"){let[t,r,i]=n,o=y(t),c=await e.resumeMultipartUpload(o,r).complete(i);return Response.json(c)}throw new Error(`${s}() is not supported.`)};var N=e=>e,k=e=>e.constructor.name==="D1Database",L=async(e,a)=>{let{operation:s,parameters:n}=await a.text().then(t=>m(t));if(s==="D1Database.dump"){let t=await e.dump();return new Response(t)}if(s==="D1Database.exec"){let[t]=n,r=await e.exec(t);return Response.json(r)}if(s==="D1Database.batch"){let[t]=n,r=await e.batch(t.map(([i,o])=>e.prepare(i).bind(...N(o))));return Response.json(r)}if(s==="D1PreparedStatement.first"){let[t,r,i]=n,o=await e.prepare(t).bind(...N(r)).first(i);return Response.json(o)}if(s==="D1PreparedStatement.all"){let[t,r]=n,i=await e.prepare(t).bind(...N(r)).all();return Response.json(i)}if(s==="D1PreparedStatement.run"){let[t,r]=n,i=await e.prepare(t).bind(...N(r)).run();return Response.json(i)}if(s==="D1PreparedStatement.raw"){let[t,r]=n,i=await e.prepare(t).bind(...N(r)).raw();return Response.json(i)}throw new Error(`${s}() is not supported.`)};var S=e=>e.constructor.name==="WorkerQueue",Q=async(e,a)=>{let{operation:s,parameters:n}=await a.text().then(t=>m(t));if(s==="Queue.send"){let[t,r]=n;return await e.send(t,r),new Response}if(s==="Queue.sendBatch"){let[t]=n;return await e.sendBatch(t),new Response}throw new Error(`${s}() is not supported.`)};var v=e=>e.constructor.name==="VectorizeIndexImpl",H=async(e,a)=>{let{operation:s,parameters:n}=await a.text().then(t=>m(t));if(s==="VectorizeIndex.describe"){let t=await e.describe();return Response.json(t)}if(s==="VectorizeIndex.query"){let[t,r]=n,i=await e.query(t,r);return Response.json(i)}if(s==="VectorizeIndex.insert"){let[t]=n,r=await e.insert(t);return Response.json(r)}if(s==="VectorizeIndex.upsert"){let[t]=n,r=await e.upsert(t);return Response.json(r)}if(s==="VectorizeIndex.deleteByIds"){let[t]=n,r=await e.deleteByIds(t);return Response.json(r)}if(s==="VectorizeIndex.getByIds"){let[t]=n,r=await e.getByIds(t);return Response.json(r)}throw new Error(`${s}() is not supported.`)};var Y=e=>{let a={};for(let[s,n]of Object.entries(e))k(n)&&(a[s]="d1"),j(n)&&(a[s]="kv"),S(n)&&(a[s]="queue"),O(n)&&(a[s]="r2"),B(n)&&(a[s]="service"),v(n)&&(a[s]="vectorize");return a};var q=(e,a)=>{let s=e.headers.get("X-BRIDGE-INTERNALS");return s==="getBindings"?Response.json(Y(a)):Response.json(`Not supported internals method: ${s}.`,{status:404})},ee=(e,a)=>{let s=e.headers.get("X-BRIDGE-BINDING-MODULE"),n=e.headers.get("X-BRIDGE-BINDING-NAME");if(!(s&&n))return new Response("Wrong usage of bridge worker. Required headers are not presented.",{status:400});let t=a[n];return t?s==="KV"&&j(t)?X(t,e).catch(r=>new Response(r.message,{status:500})):s==="SERVICE"&&B(t)?C(t,e).catch(r=>new Response(r.message,{status:500})):s==="R2"&&O(t)?J(t,e).catch(r=>new Response(r.message,{status:500})):s==="D1"&&k(t)?L(t,e).catch(r=>new Response(r.message,{status:500})):s==="QUEUE"&&S(t)?Q(t,e).catch(r=>new Response(r.message,{status:500})):s==="VECTORIZE"&&v(t)?H(t,e).catch(r=>new Response(r.message,{status:500})):new Response(`Not supported binding: ${s} or ${n} is not compatible for ${s} binding.`,{status:404}):new Response(`Failed to load env.${n}. Check your wrangler.toml and reload.`,{status:400})},Xe={async fetch(e,a,s){if(e.method==="OPTIONS")return new Response(null,{status:204,headers:{"access-control-allow-origin":"*","access-control-allow-headers":"*","access-control-allow-methods":"*"}});let n;e.headers.has("X-BRIDGE-INTERNALS")?n=await q(e,a,s):n=await ee(e,a,s);let t=new Response(n.body,n);return t.headers.set("access-control-allow-origin","*"),t}};export{Xe as default};
