var I=class extends Error{constructor(o,r){super(o),this.name="DevalueError",this.path=r.join("")}};function O(e){return Object(e)!==e}var W=Object.getOwnPropertyNames(Object.prototype).sort().join("\0");function V(e){let o=Object.getPrototypeOf(e);return o===Object.prototype||o===null||Object.getOwnPropertyNames(o).sort().join("\0")===W}function _(e){return Object.prototype.toString.call(e).slice(8,-1)}function Z(e){switch(e){case'"':return'\\"';case"<":return"\\u003C";case"\\":return"\\\\";case`
`:return"\\n";case"\r":return"\\r";case"	":return"\\t";case"\b":return"\\b";case"\f":return"\\f";case"\u2028":return"\\u2028";case"\u2029":return"\\u2029";default:return e<" "?`\\u${e.charCodeAt(0).toString(16).padStart(4,"0")}`:""}}function h(e){let o="",r=0,s=e.length;for(let t=0;t<s;t+=1){let n=e[t],c=Z(n);c&&(o+=e.slice(r,t)+c,r=t+1)}return`"${r===0?e:o+e.slice(r)}"`}function G(e){return Object.getOwnPropertySymbols(e).filter(o=>Object.getOwnPropertyDescriptor(e,o).enumerable)}var q=/^[a-zA-Z_$][a-zA-Z_$0-9]*$/;function x(e){return q.test(e)?"."+e:"["+JSON.stringify(e)+"]"}function $(e){let o=new DataView(e),r="";for(let s=0;s<e.byteLength;s++)r+=String.fromCharCode(o.getUint8(s));return te(r)}function v(e){let o=ee(e),r=new ArrayBuffer(o.length),s=new DataView(r);for(let t=0;t<r.byteLength;t++)s.setUint8(t,o.charCodeAt(t));return r}var K="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";function ee(e){e.length%4===0&&(e=e.replace(/==?$/,""));let o="",r=0,s=0;for(let t=0;t<e.length;t++)r<<=6,r|=K.indexOf(e[t]),s+=6,s===24&&(o+=String.fromCharCode((r&16711680)>>16),o+=String.fromCharCode((r&65280)>>8),o+=String.fromCharCode(r&255),r=s=0);return s===12?(r>>=4,o+=String.fromCharCode(r)):s===18&&(r>>=2,o+=String.fromCharCode((r&65280)>>8),o+=String.fromCharCode(r&255)),o}function te(e){let o="";for(let r=0;r<e.length;r+=3){let s=[void 0,void 0,void 0,void 0];s[0]=e.charCodeAt(r)>>2,s[1]=(e.charCodeAt(r)&3)<<4,e.length>r+1&&(s[1]|=e.charCodeAt(r+1)>>4,s[2]=(e.charCodeAt(r+1)&15)<<2),e.length>r+2&&(s[2]|=e.charCodeAt(r+2)>>6,s[3]=e.charCodeAt(r+2)&63);for(let t=0;t<s.length;t++)typeof s[t]>"u"?o+="=":o+=K[s[t]]}return o}function y(e,o){return P(JSON.parse(e),o)}function P(e,o){if(typeof e=="number")return t(e,!0);if(!Array.isArray(e)||e.length===0)throw new Error("Invalid input");let r=e,s=Array(r.length);function t(n,c=!1){if(n===-1)return;if(n===-3)return NaN;if(n===-4)return 1/0;if(n===-5)return-1/0;if(n===-6)return-0;if(c)throw new Error("Invalid input");if(n in s)return s[n];let a=r[n];if(!a||typeof a!="object")s[n]=a;else if(Array.isArray(a))if(typeof a[0]=="string"){let f=a[0],i=o?.[f];if(i)return s[n]=i(t(a[1]));switch(f){case"Date":s[n]=new Date(a[1]);break;case"Set":let d=new Set;s[n]=d;for(let l=1;l<a.length;l+=1)d.add(t(a[l]));break;case"Map":let u=new Map;s[n]=u;for(let l=1;l<a.length;l+=2)u.set(t(a[l]),t(a[l+1]));break;case"RegExp":s[n]=new RegExp(a[1],a[2]);break;case"Object":s[n]=Object(a[1]);break;case"BigInt":s[n]=BigInt(a[1]);break;case"null":let b=Object.create(null);s[n]=b;for(let l=1;l<a.length;l+=2)b[a[l]]=t(a[l+1]);break;case"Int8Array":case"Uint8Array":case"Uint8ClampedArray":case"Int16Array":case"Uint16Array":case"Int32Array":case"Uint32Array":case"Float32Array":case"Float64Array":case"BigInt64Array":case"BigUint64Array":{let l=globalThis[f],w=a[1],B=v(w),p=new l(B);s[n]=p;break}case"ArrayBuffer":{let l=a[1],w=v(l);s[n]=w;break}default:throw new Error(`Unknown type ${f}`)}}else{let f=new Array(a.length);s[n]=f;for(let i=0;i<a.length;i+=1){let d=a[i];d!==-2&&(f[i]=t(d))}}else{let f={};s[n]=f;for(let i in a){let d=a[i];f[i]=t(d)}}return s[n]}return t(0)}function N(e,o){let r=[],s=new Map,t=[];if(o)for(let i of Object.getOwnPropertyNames(o))t.push({key:i,fn:o[i]});let n=[],c=0;function a(i){if(typeof i=="function")throw new I("Cannot stringify a function",n);if(s.has(i))return s.get(i);if(i===void 0)return-1;if(Number.isNaN(i))return-3;if(i===1/0)return-4;if(i===-1/0)return-5;if(i===0&&1/i<0)return-6;let d=c++;s.set(i,d);for(let{key:b,fn:l}of t){let w=l(i);if(w)return r[d]=`["${b}",${a(w)}]`,d}let u="";if(O(i))u=U(i);else{let b=_(i);switch(b){case"Number":case"String":case"Boolean":u=`["Object",${U(i)}]`;break;case"BigInt":u=`["BigInt",${i}]`;break;case"Date":u=`["Date","${!isNaN(i.getDate())?i.toISOString():""}"]`;break;case"RegExp":let{source:w,flags:B}=i;u=B?`["RegExp",${h(w)},"${B}"]`:`["RegExp",${h(w)}]`;break;case"Array":u="[";for(let p=0;p<i.length;p+=1)p>0&&(u+=","),p in i?(n.push(`[${p}]`),u+=a(i[p]),n.pop()):u+=-2;u+="]";break;case"Set":u='["Set"';for(let p of i)u+=`,${a(p)}`;u+="]";break;case"Map":u='["Map"';for(let[p,g]of i)n.push(`.get(${O(p)?U(p):"..."})`),u+=`,${a(p)},${a(g)}`,n.pop();u+="]";break;case"Int8Array":case"Uint8Array":case"Uint8ClampedArray":case"Int16Array":case"Uint16Array":case"Int32Array":case"Uint32Array":case"Float32Array":case"Float64Array":case"BigInt64Array":case"BigUint64Array":{let g=$(i.buffer);u='["'+b+'","'+g+'"]';break}case"ArrayBuffer":{u=`["ArrayBuffer","${$(i)}"]`;break}default:if(!V(i))throw new I("Cannot stringify arbitrary non-POJOs",n);if(G(i).length>0)throw new I("Cannot stringify POJOs with symbolic keys",n);if(Object.getPrototypeOf(i)===null){u='["null"';for(let p in i)n.push(x(p)),u+=`,${h(p)},${a(i[p])}`,n.pop();u+="]"}else{u="{";let p=!1;for(let g in i)p&&(u+=","),p=!0,n.push(x(g)),u+=`${h(g)}:${a(i[g])}`,n.pop();u+="}"}}}return r[d]=u,d}let f=a(e);return f<0?`${f}`:`[${r.join(",")}]`}function U(e){let o=typeof e;return o==="string"?h(e):e instanceof String?h(e.toString()):e===void 0?(-1).toString():e===0&&1/e<0?(-6).toString():o==="bigint"?`["BigInt","${e}"]`:String(e)}var C=e=>decodeURIComponent(e),A=e=>e.constructor.name==="KvNamespace",z=async(e,o)=>{let{operation:r,parameters:s}=y(o.headers.get("X-BRIDGE-KV-Dispatch")??"{}");if(r==="KVNamespace.list"){let[t]=s,n=await e.list(t);return Response.json(n)}if(r==="KVNamespace.put"){let[t,n]=s,c=C(t),a=o.body??"Only for TS, never happens";return await e.put(c,a,n),new Response}if(r==="KVNamespace.getWithMetadata"){let[t,n]=s,c=C(t),{value:a,metadata:f,cacheStatus:i}=await e.getWithMetadata(c,{...typeof n!="string"?n:{},type:"stream"});return new Response(a,{headers:{"X-BRIDGE-KV-ValueIsNull":`${a===null}`,"X-BRIDGE-KV-Metadata":N(f),"X-BRIDGE-KV-CacheStatus":N(i)}})}if(r==="KVNamespace.delete"){let[t]=s,n=C(t);return await e.delete(n),new Response}throw new Error(`${r}() is not supported.`)};var D=e=>e.constructor.name==="Fetcher"||typeof e.fetch=="function",X=async(e,o)=>{let{operation:r,parameters:s}=JSON.parse(o.headers.get("X-BRIDGE-SERVICE-Dispatch")??"{}");if(r==="Fetcher.fetch"){let[t]=s,n=new Request(t,o);return n.headers.delete("X-BRIDGE-BINDING-MODULE"),n.headers.delete("X-BRIDGE-BINDING-NAME"),n.headers.delete("X-BRIDGE-SERVICE-Dispatch"),e.fetch(n)}throw new Error(`${r}() is not supported.`)};var F=e=>{let o=new Uint8Array(e.length/2);for(let r=0;r<e.length;r+=2)o[r/2]=parseInt(e.substring(r,r+2),16);return o.buffer},m=e=>decodeURIComponent(e);var E=e=>e.constructor.name==="R2Bucket",L=async(e,o)=>{let{operation:r,parameters:s}=y(o.headers.get("X-BRIDGE-R2-Dispatch")??"{}",{Headers:t=>new Headers(t),ArrayBuffer:t=>F(t)});if(r==="R2Bucket.list"){let[t]=s,n=await e.list(t);return Response.json(n)}if(r==="R2Bucket.put"){let[t,,n]=s,c=m(t),a=o.body,f=await e.put(c,a,n);return Response.json(f)}if(r==="R2Bucket.get"){let[t,n]=s,c=m(t),a=await e.get(c,n);return a===null?Response.json(null):"body"in a&&a.constructor.name==="GetResult"?new Response(a.body,{headers:{"X-BRIDGE-R2-R2ObjectJSON":JSON.stringify(a)}}):Response.json(a)}if(r==="R2Bucket.head"){let[t]=s,n=m(t),c=await e.head(n);return c===null?Response.json(null):Response.json(c)}if(r==="R2Bucket.delete"){let[t]=s,n=typeof t=="string"?m(t):t.map(c=>m(c));return await e.delete(n),new Response}if(r==="R2Bucket.createMultipartUpload"){let[t,n]=s,c=m(t),a=await e.createMultipartUpload(c,n);return Response.json(a)}if(r==="R2MultipartUpload.uploadPart"){let[t,n,c]=s,a=m(t),f=o.body??"Only for TS, never happens",d=await e.resumeMultipartUpload(a,n).uploadPart(c,f);return Response.json(d)}if(r==="R2MultipartUpload.abort"){let[t,n]=s,c=m(t);return await e.resumeMultipartUpload(c,n).abort(),new Response}if(r==="R2MultipartUpload.complete"){let[t,n,c]=s,a=m(t),i=await e.resumeMultipartUpload(a,n).complete(c);return Response.json(i)}throw new Error(`${r}() is not supported.`)};var R=e=>e,S=e=>e.constructor.name==="D1Database",Q=async(e,o)=>{let{operation:r,parameters:s}=await o.text().then(t=>y(t));if(r==="D1Database.dump"){let t=await e.dump();return new Response(t)}if(r==="D1Database.exec"){let[t]=s,n=await e.exec(t);return Response.json(n)}if(r==="D1Database.batch"){let[t]=s,n=await e.batch(t.map(([c,a])=>e.prepare(c).bind(...R(a))));return Response.json(n)}if(r==="D1PreparedStatement.first"){let[t,n,c]=s,a=await e.prepare(t).bind(...R(n)).first(c);return Response.json(a)}if(r==="D1PreparedStatement.all"){let[t,n]=s,c=await e.prepare(t).bind(...R(n)).all();return Response.json(c)}if(r==="D1PreparedStatement.run"){let[t,n]=s,c=await e.prepare(t).bind(...R(n)).run();return Response.json(c)}if(r==="D1PreparedStatement.raw"){let[t,n]=s,c=await e.prepare(t).bind(...R(n)).raw();return Response.json(c)}throw new Error(`${r}() is not supported.`)};var j=e=>e.constructor.name==="WorkerQueue",J=async(e,o)=>{let{operation:r,parameters:s}=await o.text().then(t=>y(t));if(r==="Queue.send"){let[t,n]=s;return await e.send(t,n),new Response}if(r==="Queue.sendBatch"){let[t]=s;return await e.sendBatch(t),new Response}throw new Error(`${r}() is not supported.`)};var k=e=>e.constructor.name==="VectorizeIndexImpl",H=async(e,o)=>{let{operation:r,parameters:s}=await o.text().then(t=>y(t));if(r==="VectorizeIndex.describe"){let t=await e.describe();return Response.json(t)}if(r==="VectorizeIndex.query"){let[t,n]=s,c=await e.query(t,n);return Response.json(c)}if(r==="VectorizeIndex.insert"){let[t]=s,n=await e.insert(t);return Response.json(n)}if(r==="VectorizeIndex.upsert"){let[t]=s,n=await e.upsert(t);return Response.json(n)}if(r==="VectorizeIndex.deleteByIds"){let[t]=s,n=await e.deleteByIds(t);return Response.json(n)}if(r==="VectorizeIndex.getByIds"){let[t]=s,n=await e.getByIds(t);return Response.json(n)}throw new Error(`${r}() is not supported.`)};var Y=e=>{let o={};for(let[r,s]of Object.entries(e))S(s)&&(o[r]="d1"),A(s)&&(o[r]="kv"),j(s)&&(o[r]="queue"),E(s)&&(o[r]="r2"),D(s)&&(o[r]="service"),k(s)&&(o[r]="vectorize");return o};var ae=(e,o)=>{let r=e.headers.get("X-BRIDGE-INTERNALS");return r==="getBindings"?Response.json(Y(o)):Response.json(`Not supported internals method: ${r}.`,{status:404})},ie=(e,o)=>{let r=e.headers.get("X-BRIDGE-BINDING-MODULE"),s=e.headers.get("X-BRIDGE-BINDING-NAME");if(!(r&&s))return new Response("Wrong usage of bridge worker. Required headers are not presented.",{status:400});let t=o[s];return t?r==="KV"&&A(t)?z(t,e).catch(n=>new Response(n.message,{status:500})):r==="SERVICE"&&D(t)?X(t,e).catch(n=>new Response(n.message,{status:500})):r==="R2"&&E(t)?L(t,e).catch(n=>new Response(n.message,{status:500})):r==="D1"&&S(t)?Q(t,e).catch(n=>new Response(n.message,{status:500})):r==="QUEUE"&&j(t)?J(t,e).catch(n=>new Response(n.message,{status:500})):r==="VECTORIZE"&&k(t)?H(t,e).catch(n=>new Response(n.message,{status:500})):new Response(`Not supported binding: ${r} or ${s} is not compatible for ${r} binding.`,{status:404}):new Response(`Failed to load env.${s}. Check your wrangler.toml and reload.`,{status:400})},Fe={async fetch(e,o,r){if(e.method==="OPTIONS")return new Response(null,{status:204,headers:{"access-control-allow-origin":"*","access-control-allow-headers":"*","access-control-allow-methods":"*"}});let s;e.headers.has("X-BRIDGE-INTERNALS")?s=await ae(e,o,r):s=await ie(e,o,r);let t=new Response(s.body,s);return t.headers.set("access-control-allow-origin","*"),t}};export{Fe as default};
